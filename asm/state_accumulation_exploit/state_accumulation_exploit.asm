; ==========================================
; state_accumulation_exploit.asm
; MSP430 firmware
; By Samuel Tan <samueltan@gmail.com>
; ==========================================
;
; Simple MSP430 Firmware vulnerable to the state
; accumulation exploit described in my IOP paper.
; Refer to paper for detailed narration of code

.org 0x3100

RESET_HANDLER:
    mov.w #0x13DA, R1       ; initialize SP
    mov.w #0x5AE0, &0x120   ; disable WDT, NMI mode, accepted on falling edge
    mov.w #0x0, &0x200      ; clear state accumulation destination
    bic.b #0x1, &0x0021     ; turn off LED (if it is on)
spin1:
    bis.b #0x10, &0x000     ; enable NMI
    cmp.w #0x4, &0x200      ; stop spinning only if we accumulated state of 0x4
    jnz spin1

    bis.b #0x1, &0x0022     ; turn on LED
    bis.b #0x1, &0x0021
spin2:
    jmp spin2

.org 0x3400

NMI_HANDLER:                
    bic.b #0x10, &0x002     ; clear NMI interrupt flag
    add.w #1, &0x200        ; accumulate 0x1 of state
    reti

    .org 0xfffc             ; interrupt vector table entries
    .word 0x3400
    .org 0xfffe
    .word 0x3100