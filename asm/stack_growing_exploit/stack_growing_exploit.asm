; ==========================================
; stack_growing_exploit.asm
; MSP430 firmware
; By Samuel Tan <samueltan@gmail.com>
; ==========================================
;
; Simple MSP430 Firmware vulnerable to the stack
; growing exploit described in my IOP paper.
; Refer to paper for detailed narration of code

.org 0x3100

RESET_HANDLER:
    mov.w #0x5AE0, &0x120   ; disable WDT, NMI mode, accepted on falling edge
    mov.w #0xFFFF, R11      ; set BSL password check bit
    mov.w #0xC0C, R1        ; initialize SP
    bis.b #0x10, &0x000     ; enable NMI
spin:
    jmp spin

.org 0x3400

NMI_HANDLER:
    bic.b #0x10, &0x002     ; clear NMI interrupt flag
    bis.b #0x10, &0x000     ; enable NMI
    nop
sp_check_loop:
    cmp.w #0x0C00, R1       ; stop spinning if SP is in right place
    jnz sp_check_loop
    bis.b #0x1, &0x0022     ; light up LED
    bis.b #0x1, &0x0021
    reti

    .org 0xfffc             ; interrupt vector table entries
    .word 0x3400
    .org 0xfffe
    .word 0x3100